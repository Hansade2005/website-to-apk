name: Build PiPilot APK

on:
  workflow_dispatch:
    inputs:
      website_url:
        description: 'Website URL to wrap[](https://pipilot.dev)'
        required: true
        type: string
      app_name:
        description: 'App name shown on phone'
        required: true
        type: string
      app_id:
        description: 'ID suffix (pipilot â†’ com.pipilot.webtoapk)'
        required: false
        default: 'pipilot'
        type: string
      enable_js:
        description: 'Enable JavaScript in the app?'
        required: false
        default: true
        type: boolean
      allow_external_links:
        description: 'Open external links in browser?'
        required: false
        default: true
        type: boolean
      splash_image_url:
        description: 'Optional: URL to splash screen image (PNG)'
        required: false
        type: string
      bottom_tabs:
        description: 'Optional: Bottom tabs config (e.g., "Home:https://example.com, About:https://example.com/about")'
        required: false
        type: string
      slider_menu:
        description: 'Optional: Slider menu config (e.g., "Home:https://example.com, Info:text:App Information")'
        required: false
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      JAVA_HOME: /opt/hostedtoolcache/Java_Temurin-Hotspot_jdk/17.0.17-10/x64
      JAVA_HOME_17_X64: /opt/hostedtoolcache/Java_Temurin-Hotspot_jdk/17.0.17-10/x64
      ANDROID_HOME: /usr/local/lib/android/sdk

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle

      - name: Set up Android command-line tools
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: 'latest'

      - name: Install required Android SDK components
        run: |
          sdkmanager --install \
            "platform-tools" \
            "platforms;android-33" \
            "build-tools;33.0.2" || true
          yes | sdkmanager --licenses

      - name: Bypass local cmdline-tools check (symlink trick)
        run: |
          mkdir -p ./cmdline-tools/latest
          ln -s $ANDROID_HOME/cmdline-tools/latest/bin ./cmdline-tools/latest/bin
          ln -s $ANDROID_HOME/cmdline-tools/latest/lib ./cmdline-tools/latest/lib
          echo "Symlinked real SDK tools into ./cmdline-tools/latest"

      - name: Make build script executable
        run: chmod +x make.sh

      - name: Create base webapk.conf
        run: |
          cat > webapk.conf << 'EOF'
          id = placeholder
          name = Placeholder App
          mainURL = https://example.com
          icon = icon.png
          allowSubdomains = true
          requireDoubleBackToExit = true
          enableExternalLinks = true
          openExternalLinksInBrowser = true
          JSEnabled = true
          EOF

      - name: Apply user inputs to webapk.conf
        run: |
          sed -i "s|^mainURL = .*|mainURL = ${{ inputs.website_url }}|" webapk.conf
          sed -i "s|^name = .*|name = ${{ inputs.app_name }}|" webapk.conf
          sed -i "s|^id = .*|id = ${{ inputs.app_id }}|" webapk.conf

          JS_VALUE=$([[ "${{ inputs.enable_js }}" == "true" ]] && echo "true" || echo "false")
          sed -i "s|^JSEnabled = .*|JSEnabled = $JS_VALUE|" webapk.conf

          EXTERNAL_VALUE=$([[ "${{ inputs.allow_external_links }}" == "true" ]] && echo "true" || echo "false")
          sed -i "s|^openExternalLinksInBrowser = .*|openExternalLinksInBrowser = $EXTERNAL_VALUE|" webapk.conf

          echo "Final configuration:"
          cat webapk.conf

      - name: Download splash image if provided
        if: inputs.splash_image_url != ''
        run: |
          echo "Downloading splash image from ${{ inputs.splash_image_url }}"
          wget -O splash.png "${{ inputs.splash_image_url }}" || echo "Failed to download splash image"
          if [ -f splash.png ]; then
            sed -i "s|^splashImage = .*|splashImage = splash.png|" webapk.conf
            echo "Splash image configured"
          fi

      - name: Configure bottom tabs if provided
        if: inputs.bottom_tabs != ''
        run: |
          echo "Configuring bottom tabs: ${{ inputs.bottom_tabs }}"
          sed -i "s|^bottomTabs = .*|bottomTabs = ${{ inputs.bottom_tabs }}|" webapk.conf
          echo "Bottom tabs configured"

      - name: Configure slider menu if provided
        if: inputs.slider_menu != ''
        run: |
          echo "Configuring slider menu: ${{ inputs.slider_menu }}"
          sed -i "s|^sliderMenu = .*|sliderMenu = ${{ inputs.slider_menu }}|" webapk.conf
          echo "Slider menu configured"

      - name: Generate signing keystore (only needed once per runner)
        run: ./make.sh keygen

      - name: Build the APK
        run: ./make.sh build

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.app_name || 'pipilot' }}-apk
          path: ./*.apk
          if-no-files-found: error
