name: Build Website-to-APK with Inputs

on:
  workflow_dispatch:
    inputs:
      website_url:
        description: 'The full website URL to wrap (e.g., https://example.com)'
        required: true
        type: string
      app_name:
        description: 'Name of the Android app as shown on device'
        required: true
        type: string
      app_id:
        description: 'App ID suffix (e.g., myapp → becomes com.myapp.webtoapk)'
        required: false
        type: string
        default: 'mywebapp'
      enable_js:
        description: 'Enable JavaScript in WebView?'
        required: false
        type: boolean
        default: true
      allow_external_links:
        description: 'Open external links in browser?'
        required: false
        type: boolean
        default: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Accept Android SDK licenses
        run: |
          mkdir -p "$HOME/.android"
          echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > "$HOME/.android/repositories.cfg"
          yes | "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" --licenses || true

      - name: Cache Gradle and Android SDK
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.android
            cmdline-tools
            openjdk
          key: ${{ runner.os }}-apk-build-${{ hashFiles('make.sh', 'gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: ${{ runner.os }}-apk-build-

      - name: Make build script executable
        run: chmod +x make.sh

      - name: Apply user inputs to webapk.conf
        run: |
          # Update config with inputs (inputs.<name> preserves boolean type)
          sed -i "s|^mainURL = .*|mainURL = ${{ inputs.website_url }}|" webapk.conf
          sed -i "s|^name = .*|name = ${{ inputs.app_name }}|" webapk.conf
          sed -i "s|^id = .*|id = ${{ inputs.app_id }}|" webapk.conf
          
          # Boolean handling – convert to lowercase true/false string expected by config
          JS_VALUE=$([[ "${{ inputs.enable_js }}" == "true" ]] && echo "true" || echo "false")
          sed -i "s|^JSEnabled = .*|JSEnabled = $JS_VALUE|" webapk.conf
          
          EXTERNAL_VALUE=$([[ "${{ inputs.allow_external_links }}" == "true" ]] && echo "true" || echo "false")
          sed -i "s|^openExternalLinksInBrowser = .*|openExternalLinksInBrowser = $EXTERNAL_VALUE|" webapk.conf

          # Optional: Add more sed commands for other config options as needed

          # Show what we configured (for debugging in logs)
          cat webapk.conf

      - name: Build APK
        run: ./make.sh build

      - name: Upload built APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: website-apk-${{ inputs.app_name || 'unnamed' }}
          path: ./*.apk
          if-no-files-found: error
