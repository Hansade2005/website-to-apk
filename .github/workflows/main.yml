name: Build Website-to-APK (PiPilot)

on:
  workflow_dispatch:
    inputs:
      website_url:
        description: 'Website URL to wrap (e.g. https://pipilot.dev)'
        required: true
        type: string
      app_name:
        description: 'App name shown on device'
        required: true
        type: string
      app_id:
        description: 'App ID suffix (e.g. pipilot â†’ com.pipilot.webtoapk)'
        required: false
        type: string
        default: 'pipilot'
      enable_js:
        description: 'Enable JavaScript?'
        required: false
        type: boolean
        default: true
      allow_external_links:
        description: 'Open external links in browser?'
        required: false
        type: boolean
        default: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Android command-line tools
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: 'latest'

      - name: Install required Android SDK components
        run: |
          # Install exactly what the project template needs (API 33 target)
          sdkmanager --install \
            "platform-tools" \
            "platforms;android-33" \
            "build-tools;33.0.2" || echo "Some packages already installed"
          # Accept all licenses non-interactively
          yes | sdkmanager --licenses

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/gradle-wrapper.properties', 'make.sh') }}
          restore-keys: ${{ runner.os }}-gradle-

      - name: Make script executable
        run: chmod +x make.sh

      - name: Create minimal webapk.conf
        run: |
          cat > webapk.conf << 'EOF'
          # Minimal config - overridden below
          id = placeholder
          name = Placeholder
          mainURL = https://example.com
          icon = icon.png           # commit your icon.png to repo root if desired
          allowSubdomains = true
          requireDoubleBackToExit = true
          enableExternalLinks = true
          openExternalLinksInBrowser = true
          JSEnabled = true
          EOF

      - name: Apply workflow inputs to config
        run: |
          sed -i "s|^mainURL = .*|mainURL = ${{ inputs.website_url }}|" webapk.conf
          sed -i "s|^name = .*|name = ${{ inputs.app_name }}|" webapk.conf
          sed -i "s|^id = .*|id = ${{ inputs.app_id }}|" webapk.conf

          JS_VALUE=$([[ "${{ inputs.enable_js }}" == "true" ]] && echo "true" || echo "false")
          sed -i "s|^JSEnabled = .*|JSEnabled = $JS_VALUE|" webapk.conf

          EXT_VALUE=$([[ "${{ inputs.allow_external_links }}" == "true" ]] && echo "true" || echo "false")
          sed -i "s|^openExternalLinksInBrowser = .*|openExternalLinksInBrowser = $EXT_VALUE|" webapk.conf

          echo "Applied configuration:"
          cat webapk.conf

      - name: Run build script
        run: ./make.sh build

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.app_name || 'pipilot' }}-apk
          path: ./*.apk
          if-no-files-found: error
